PREFIX sp: <http://example.org/smartphone#>
PREFIX spv: <http://example.org/smartphone/vocab/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

# CQ2: Phone Recommendation by Overall Sentiment
# Question: Which phones have the best overall sentiment score?

SELECT ?phoneName ?brandName
       ?totalReviews
       (COALESCE(?positiveCount, 0) AS ?positiveCount)
       (COALESCE(?negativeCount, 0) AS ?negativeCount)
       ((COALESCE(?positiveCount, 0) - COALESCE(?negativeCount, 0)) AS ?sentimentScore)
       ((COALESCE(?positiveCount, 0) * 100.0 / ?totalReviews) AS ?positivePercentage)
WHERE {
  # Get phone and brand
  ?phone a sp:Smartphone ;
         sp:phoneName ?phoneName ;
         sp:hasBrand ?brand .

  ?brand sp:brandName ?brandName .

  # Count total reviews
  {
    SELECT ?phone (COUNT(DISTINCT ?review) AS ?totalReviews)
    WHERE {
      ?review sp:reviewOf ?phone .
    }
    GROUP BY ?phone
  }

  # Count positive Overall sentiment
  OPTIONAL {
    SELECT ?phone (COUNT(DISTINCT ?review) AS ?positiveCount)
    WHERE {
      ?review sp:reviewOf ?phone ;
              sp:hasPositiveSentimentTag spv:Overall .
    }
    GROUP BY ?phone
  }

  # Count negative Overall sentiment
  OPTIONAL {
    SELECT ?phone (COUNT(DISTINCT ?review) AS ?negativeCount)
    WHERE {
      ?review sp:reviewOf ?phone ;
              sp:hasNegativeSentimentTag spv:Overall .
    }
    GROUP BY ?phone
  }

  # Filter phones with at least 5 reviews
  FILTER(?totalReviews >= 5)
}
ORDER BY DESC(?sentimentScore) DESC(?positivePercentage)
LIMIT 20
