@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix sp: <http://example.org/smartphone#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix spsh: <http://example.org/smartphone/shapes/> .

spsh:SmartphoneShape a sh:NodeShape ;
    sh:targetClass sp:Smartphone ;
    sh:property [
        sh:path sp:phoneName ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
        sh:message "Smartphone must have exactly one non-empty name"
    ] ;
    sh:property [
        sh:path sp:hasBrand ;
        sh:class sp:Brand ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Smartphone must be linked to exactly one Brand"
    ] ;
    sh:property [
        sh:path sp:batteryCapacityMah ;
        sh:datatype xsd:integer ;
        sh:minInclusive 500 ;
        sh:maxInclusive 10000 ;
        sh:message "Battery capacity must be between 500 and 10000 mAh"
    ] ;
    sh:property [
        sh:path sp:mainCameraMP ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:maxInclusive 300 ;
        sh:message "Main camera must be between 1 and 300 MP"
    ] ;
    sh:property [
        sh:path sp:releaseYear ;
        sh:datatype xsd:integer ;
        sh:minInclusive 2000 ;
        sh:maxInclusive 2030 ;
        sh:message "Release year must be between 2000 and 2030"
    ] .

spsh:BrandShape a sh:NodeShape ;
    sh:targetClass sp:Brand ;
    sh:property [
        sh:path sp:brandName ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
        sh:message "Brand must have exactly one non-empty name"
    ] .

spsh:UserShape a sh:NodeShape ;
    sh:targetClass sp:User ;
    sh:property [
        sh:path sp:userId ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
        sh:message "User must have exactly one non-empty user ID"
    ] ;
    sh:property [
        sh:path sp:persona ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "User must have exactly one persona"
    ] ;
    sh:property [
        sh:path sp:interestedIn ;
        sh:class skos:Concept ;
        sh:minCount 1 ;
        sh:message "User must be interested in at least one use-case or price segment"
    ] .

spsh:VariantShape a sh:NodeShape ;
    sh:targetClass sp:Variant ;
    sh:property [
        sh:path sp:variantOf ;
        sh:class sp:Phone ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Variant must be linked to exactly one phone"
    ] ;
    sh:property [
        sh:path sp:storageGB ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:maxInclusive 2000 ;
        sh:message "Storage must be between 1 and 2000 GB"
    ] ;
    sh:property [
        sh:path sp:ramGB ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:maxInclusive 128 ;
        sh:message "RAM must be between 1 and 128 GB"
    ] .


spsh:PhoneVariantConsistencyShape a sh:NodeShape ;
    sh:targetClass sp:Phone ;
    rdfs:label "Phone-Variant Consistency" ;
    rdfs:comment "Ensures variant references are bidirectional" ;
    sh:sparql [
        sh:message "Variant must reference back to this phone via variantOf" ;
        sh:prefixes [
            sh:declare [ sh:prefix "sp" ; sh:namespace "http://example.org/smartphone#"^^xsd:anyURI ]
        ] ;
        sh:select """
            SELECT $this ?variant
            WHERE {
                $this sp:hasVariant ?variant .
                FILTER NOT EXISTS { ?variant sp:variantOf $this }
            }
        """
    ] .

spsh:UserLikesConsistencyShape a sh:NodeShape ;
    sh:targetClass sp:User ;
    rdfs:label "User Likes Consistency" ;
    rdfs:comment "Ensures users only like smartphones, not other types" ;
    sh:sparql [
        sh:message "User can only like instances of sp:Smartphone" ;
        sh:prefixes [
            sh:declare [ sh:prefix "sp" ; sh:namespace "http://example.org/smartphone#"^^xsd:anyURI ]
        ] ;
        sh:select """
            SELECT $this ?liked
            WHERE {
                $this sp:likes ?liked .
                FILTER NOT EXISTS { ?liked a sp:Smartphone }
            }
        """
    ] .
