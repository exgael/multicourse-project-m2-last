PREFIX sp: <http://example.org/smartphone#>
PREFIX spv: <http://example.org/smartphone/vocab/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

# CQ2: Get personalized phone recommendations for a user
# Question: What phones should we recommend to a user based on their interests?

SELECT ?phoneName ?brandName
       (GROUP_CONCAT(DISTINCT ?usecase; separator=", ") AS ?usecases)
       ?matchingInterests ?avgPrice
WHERE {
  {
    SELECT ?phone ?phoneName ?brandName
           (COUNT(DISTINCT ?sharedInterest) AS ?matchingInterests)
           (AVG(?priceValue) AS ?avgPrice)
    WHERE {
      # User interests
      ?user sp:userId "gamer_0000" ;
            sp:interestedIn ?sharedInterest .

      # Phones suitable for same interests
      ?phone sp:suitableFor ?sharedInterest ;
             sp:phoneName ?phoneName ;
             sp:hasBrand ?brand .

      ?brand sp:brandName ?brandName .

      # Get price
      OPTIONAL {
        ?phone sp:priceEUR ?priceValue .
      }

      # Exclude phones user already likes
      FILTER NOT EXISTS {
        ?user sp:likes ?phone .
      }
    }
    GROUP BY ?phone ?phoneName ?brandName
  }

  # Get phone use-cases
  OPTIONAL {
    ?phone sp:suitableFor ?uc .
    BIND(STRAFTER(STR(?uc), "vocab/") AS ?usecase)
  }
}
GROUP BY ?phoneName ?brandName ?matchingInterests ?avgPrice
ORDER BY DESC(?matchingInterests) ?avgPrice
LIMIT 10
