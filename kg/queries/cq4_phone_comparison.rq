PREFIX sp: <http://example.org/smartphone#>
PREFIX spv: <http://example.org/smartphone/vocab/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# CQ4: Compare phones based on specs and user popularity
# Question: Compare phones for a specific use-case with specs and popularity metrics

SELECT ?phoneName ?brandName
       ?batteryCapacity ?mainCameraMP ?ramGB ?storageGB
       ?avgPrice ?userLikes ?versatility
WHERE {
  {
    SELECT ?phone ?phoneName ?brandName
           ?batteryCapacity ?mainCameraMP ?ramGB ?storageGB
           (AVG(?priceValue) AS ?avgPrice)
           (COUNT(DISTINCT ?user) AS ?userLikes)
           (COUNT(DISTINCT ?usecase) AS ?versatility)
    WHERE {
      # Phones suitable for Gaming use-case
      ?phone sp:suitableFor spv:Gaming ;
             sp:phoneName ?phoneName ;
             sp:hasBrand ?brand ;
             sp:batteryCapacityMah ?batteryCapacity ;
             sp:mainCameraMP ?mainCameraMP .

      ?brand sp:brandName ?brandName .

      # Optional specs
      OPTIONAL { ?phone sp:ramGB ?ramGB . }
      OPTIONAL { ?phone sp:storageGB ?storageGB . }

      # Price
      OPTIONAL {
        ?phone sp:priceEUR ?priceValue .
      }

      # Count users who like this phone
      OPTIONAL {
        ?user sp:likes ?phone .
      }

      # Count use-cases this phone is suitable for (versatility)
      OPTIONAL {
        ?phone sp:suitableFor ?usecase .
      }
    }
    GROUP BY ?phone ?phoneName ?brandName ?batteryCapacity ?mainCameraMP ?ramGB ?storageGB
    HAVING (COUNT(DISTINCT ?user) > 0)
  }
}
ORDER BY DESC(?userLikes) DESC(?versatility) ?avgPrice
LIMIT 15
