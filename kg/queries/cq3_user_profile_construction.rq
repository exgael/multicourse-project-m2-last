PREFIX sp: <http://example.org/smartphone#>
PREFIX spv: <http://example.org/smartphone/vocab/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

# CQ3: Construct user profile with aggregated preferences
# Question: Build a comprehensive user profile with interests and liked phones

CONSTRUCT {
  ?user a sp:User ;
        sp:userId ?userId ;
        sp:persona ?persona ;
        sp:interestedIn ?interest ;
        sp:likes ?phone ;
        sp:hasPreferenceScore ?score .

  ?phone sp:phoneName ?phoneName ;
         sp:suitableFor ?phoneUsecase .
}
WHERE {
  ?user a sp:User ;
        sp:userId ?userId ;
        sp:persona ?persona .

  # User interests
  OPTIONAL {
    ?user sp:interestedIn ?interest .
  }

  # Phones user likes
  OPTIONAL {
    ?user sp:likes ?phone .

    ?phone sp:phoneName ?phoneName ;
           sp:suitableFor ?phoneUsecase .
  }

  # Calculate preference score based on interest alignment
  OPTIONAL {
    SELECT ?user (COUNT(?match) AS ?score)
    WHERE {
      ?user sp:interestedIn ?int .
      ?user sp:likes ?p .
      ?p sp:suitableFor ?int .
      BIND(?int AS ?match)
    }
    GROUP BY ?user
  }

  FILTER(?userId = "gamer_0000")
}
